{
    "name": "EC2 Instance Analysis Jobs",
    "statements": [
        {
            "query": "MATCH (:CloudanixWorkspace{id: $WORKSPACE_ID})-[:OWNER]->(:AWSOrganization{id: $ORGANIZATION_ID})-[:OWNER]->(:AWSAccount{id: $AWS_ID})-[:RESOURCE]->(n:EC2Instance) where EXISTS(n.iamroles) WITH n LIMIT $LIMIT_SIZE REMOVE n.iamroles return COUNT(*) as TotalCompleted",
            "iterative": true,
            "iterationsize": 100
        },
        {
            "__comment": "List EC2 Instance IAM Roles",
            "query": "MATCH (:CloudanixWorkspace{id: $WORKSPACE_ID})-[:OWNER]->(:AWSOrganization{id: $ORGANIZATION_ID})-[:OWNER]->(aa:AWSAccount{id: $AWS_ID})-[:RESOURCE]->(i:EC2Instance)-[:USES]->(ar:AWSRole) SET (CASE WHEN NOT ar.arn IN coalesce(i.iamroles , []) THEN i END).iamroles = coalesce(i.iamroles , []) + ar.arn;",
            "iterative": false
        }
    ]
}