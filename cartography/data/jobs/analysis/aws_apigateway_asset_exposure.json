{
  "statements": [
    {
      "query": "MATCH (rest_api:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE EXISTS(rest_api.exposed_internet) WITH rest_api LIMIT $LIMIT_SIZE REMOVE rest_api.exposed_internet, rest_api.exposed_internet_type, rest_api.publicContext return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (rest_api:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WITH rest_api LIMIT $LIMIT_SIZE REMOVE rest_api.anonymous_access_type return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (rest_api_resource:APIGatewayResource)<-[:RESOURCE]-(:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE EXISTS(rest_api_resource.exposed_internet) WITH rest_api_resource LIMIT $LIMIT_SIZE REMOVE rest_api_resource.exposed_internet, rest_api_resource.exposed_internet_type, rest_api_resource.publicContext return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (rest_api_resource:APIGatewayResource)<-[:RESOURCE]-(:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WITH rest_api_resource LIMIT $LIMIT_SIZE REMOVE rest_api_resource.anonymous_access, rest_api_resource.anonymous_access_type return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (rest_api:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE 'REGIONAL' in rest_api.endpoint_conf_types OR 'EDGE' in rest_api.endpoint_conf_types SET rest_api.exposed_internet = true, (CASE WHEN NOT 'endpoint_type' IN coalesce(rest_api.exposed_internet_type , []) THEN rest_api END).exposed_internet_type = coalesce(rest_api.exposed_internet_type , []) + 'endpoint_type';",
      "iterative": false
    },
    {
      "query": "MATCH (rest_api:APIGatewayRestAPI{anonymous_access: true})<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) SET (CASE WHEN NOT 'policy' IN  coalesce(rest_api.anonymous_access_type , []) THEN rest_api END).anonymous_access_type = coalesce(rest_api.anonymous_access_type , []) + 'policy';",
      "iterative": false
    },
    {
      "query": "MATCH (rest_api_resource:APIGatewayResource)<-[:RESOURCE]-(:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE 'REGIONAL' in rest_api_resource.endpoint_conf_types OR 'EDGE' in rest_api_resource.endpoint_conf_types SET rest_api_resource.exposed_internet = true, (CASE WHEN NOT 'api_gateway_endpoint_type' IN coalesce(rest_api_resource.exposed_internet_type , []) THEN rest_api_resource END).exposed_internet_type = coalesce(rest_api_resource.exposed_internet_type , []) + 'api_gateway_endpoint_type';",
      "iterative": false
    },
    {
      "query": "MATCH (rest_api_resource:APIGatewayResource)<-[:RESOURCE]-(:APIGatewayRestAPI{anonymous_access: true})<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) SET rest_api_resource.anonymous_access = true, (CASE WHEN NOT 'api_gateway_policy' IN  coalesce(rest_api_resource.anonymous_access_type , []) THEN rest_api_resource END).anonymous_access_type = coalesce(rest_api_resource.anonymous_access_type , []) + 'api_gateway_policy';",
      "iterative": false
    },
    {
      "query": "MATCH (rest_api:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rest_api.exposed_internet = true WITH rest_api SET rest_api.publicContext = apoc.convert.toJson([{resource: rest_api.id, resourceType: 'aws-apigateway-restapi', context: [{apiId: rest_api.id, apiName: rest_api.name, endpointTypes: rest_api.endpoint_conf_types, exposureTypes: rest_api.exposed_internet_type, anonymousAccess: coalesce(rest_api.anonymous_access, false), anonymousAccessType: coalesce(rest_api.anonymous_access_type, [])}]}])",
      "iterative": false
    },
    {
      "query": "MATCH (rest_api_resource:APIGatewayResource)<-[:RESOURCE]-(rest_api:APIGatewayRestAPI)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rest_api_resource.exposed_internet = true WITH rest_api_resource, rest_api SET rest_api_resource.publicContext = apoc.convert.toJson([{resource: rest_api_resource.id, resourceType: 'aws-apigateway-resource', context: [{resourceId: rest_api_resource.id, resourcePath: rest_api_resource.path, apiId: rest_api.id, apiName: rest_api.name, endpointTypes: rest_api_resource.endpoint_conf_types, exposureTypes: rest_api_resource.exposed_internet_type, anonymousAccess: coalesce(rest_api_resource.anonymous_access, false), anonymousAccessType: coalesce(rest_api_resource.anonymous_access_type, [])}]}])",
      "iterative": false
    }
  ],
  "name": "AWS apigateway asset internet exposure"
}
