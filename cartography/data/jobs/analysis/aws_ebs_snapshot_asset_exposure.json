{
  "statements": [
    {
      "query": "MATCH (snapshot:EBSSnapshot)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE EXISTS(snapshot.exposed_internet) WITH snapshot LIMIT $LIMIT_SIZE REMOVE snapshot.exposed_internet, snapshot.exposed_internet_type, snapshot.publicContext return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (snapshot:EBSSnapshot)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE 'all' in snapshot.volume_permissions SET snapshot.exposed_internet = true ,(CASE WHEN NOT 'ebs_volume_permissions_group' IN coalesce(snapshot.exposed_internet_type , []) THEN snapshot END).exposed_internet_type = coalesce(snapshot.exposed_internet_type , []) + 'ebs_volume_permissions_group';",
      "iterative": false
    },
    {
      "query": "MATCH (snapshot:EBSSnapshot)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE snapshot.exposed_internet = true WITH snapshot SET snapshot.publicContext = apoc.convert.toJson([{resource: snapshot.id, resourceType: 'aws-ec2-ebs-snapshot', context: [{snapshotId: snapshot.id, volumeId: snapshot.volumeid, volumeSize: snapshot.volumesize, encrypted: coalesce(snapshot.encrypted, false), volumePermissions: snapshot.volume_permissions, exposureTypes: snapshot.exposed_internet_type, description: coalesce(snapshot.description, '')}]}])",
      "iterative": false
    }
  ],
  "name": "aws ebs snapshot asset internet exposure"
}
