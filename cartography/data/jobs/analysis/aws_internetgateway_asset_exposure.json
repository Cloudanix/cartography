{
  "statements": [
    {
      "query": "MATCH (ig:AWSInternetGateway)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE EXISTS(ig.exposed_internet) WITH ig LIMIT $LIMIT_SIZE REMOVE ig.exposed_internet, ig.exposed_internet_type, ig.publicContext return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (vpc:AWSVpc)-[:ATTACHED_TO]->(:AWSInternetGateway)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE EXISTS(vpc.exposed_internet) WITH vpc LIMIT $LIMIT_SIZE REMOVE vpc.exposed_internet, vpc.exposed_internet_type, vpc.publicContext return COUNT(*) as TotalCompleted",
      "iterative": true,
      "iterationsize": 100
    },
    {
      "query": "MATCH (ig:AWSInternetGateway)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) SET ig.exposed_internet = true ,(CASE WHEN NOT 'internet_gateway_endpoint_type' IN coalesce(ig.exposed_internet_type , []) THEN ig END).exposed_internet_type = coalesce(ig.exposed_internet_type , []) + 'internet_gateway_endpoint_type';",
      "iterative": false
    },
    {
      "query": "MATCH (vpc:AWSVpc)-[:ATTACHED_TO]->(:AWSInternetGateway)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) SET vpc.exposed_internet = true ,(CASE WHEN NOT 'internet_gateway_endpoint_type' IN coalesce(vpc.exposed_internet_type , []) THEN vpc END).exposed_internet_type = coalesce(vpc.exposed_internet_type , []) + 'internet_gateway_endpoint_type';",
      "iterative": false
    },
    {
      "query": "MATCH (ig:AWSInternetGateway)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE ig.exposed_internet = true WITH ig OPTIONAL MATCH (vpc:AWSVpc)-[:ATTACHED_TO]->(ig) WITH ig, collect(DISTINCT {vpcId: vpc.id, cidrBlock: vpc.cidr_block}) as attachedVpcs SET ig.publicContext = apoc.convert.toJson([{resource: ig.id, resourceType: 'aws-networking-internetgateway', context: [{internetGatewayId: ig.id, exposureTypes: ig.exposed_internet_type, attachedVpcs: attachedVpcs}]}])",
      "iterative": false
    },
    {
      "query": "MATCH (vpc:AWSVpc)-[:ATTACHED_TO]->(ig:AWSInternetGateway)<-[:RESOURCE]-(:AWSAccount{id: $AWS_ID})<-[:OWNER]-(:AWSOrganization{id: $ORGANIZATION_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE vpc.exposed_internet = true WITH vpc, ig SET vpc.publicContext = apoc.convert.toJson([{resource: vpc.id, resourceType: 'aws-networking-vpc', context: [{vpcId: vpc.id, cidrBlock: vpc.cidr_block, internetGatewayId: ig.id, exposureTypes: vpc.exposed_internet_type, isDefault: coalesce(vpc.is_default, false)}]}])",
      "iterative": false
    }
  ],
  "name": "aws internet gateway asset internet exposure"
}
