{
	"statements": [
		{
			"query": "MATCH ((n:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID})) WHERE EXISTS(n.exposed_internet) WITH n LIMIT $LIMIT_SIZE REMOVE n.exposed_internet, n.exposed_internet_type RETURN COUNT(*) as TotalCompleted",
			"iterative": true,
			"iterationsize": 100
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule)<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.access='Allow' AND rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'direct_ipv4' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'direct_ipv4';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.destination_port_range IN ['0-65535', '80-8080', '111-32800'] OR '0-65535' IN rule.destination_port_ranges OR '80-8080' IN rule.destination_port_ranges OR '111-32800' IN rule.destination_port_ranges SET group.exposed_internet = true, (CASE WHEN NOT 'inbound_public_ports' IN coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'inbound_public_ports';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'TCP',  destination_port_range: '445'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_cifs' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_cifs';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', destination_port_range: '53'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_dns' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_dns';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'TCP'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.destination_port_range in ['21', '20'] AND rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_ftp' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_ftp';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'TCP',  destination_port_range: '80'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_http' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_http';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'ICMP'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_icmp' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_icmp';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'TCP',  destination_port_range: '22'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_ssh' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_ssh';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'TCP',  destination_port_range: '23'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_telnet' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_telnet';",
			"iterative": false
		},
		{
			"query": "MATCH (rule:AzureNetworkSecurityRule{direction: 'Inbound', access: 'Allow', protocol: 'UDP'})<-[:CONTAIN]-(group:AzureNetworkSecurityGroup)<-[:RESOURCE]-(:AzureSubscription{id: $AZURE_SUBSCRIPTION_ID})<-[:RESOURCE]-(:AzureTenant{id: $AZURE_TENANT_ID})<-[:OWNER]-(:CloudanixWorkspace{id: $WORKSPACE_ID}) WHERE rule.source_address_prefix IN ['0.0.0.0/0', '::/0', '*', 'Internet'] SET group.exposed_internet = true, (CASE WHEN NOT 'public_udp' IN  coalesce(group.exposed_internet_type , []) THEN group END).exposed_internet_type = coalesce(group.exposed_internet_type , []) + 'public_udp';",
			"iterative": false
		}
	],
	"name": "Azure security group asset internet exposure"
}
